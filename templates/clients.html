{% extends "base.html" %} {% block title %}Clients - BreakFree{% endblock %} {%
block page_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/clients.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/modals.css') }}"
/>
{% endblock %} {% block content %}
<div class="main-header-clients">
  <div class="actions actions-left">
    <div class="search-container">
      <span class="search-icon"><i class="fas fa-search"></i></span>
      <input type="text" placeholder="Search by name, ID, or barangay..." />
    </div>
  </div>
  <div class="actions actions-right">
    {% if session.role == 'admin' %}
    <a href="{{ url_for('pending_clients') }}" class="btn-secondary">
      <i class="fas fa-clock"></i> Pending Clients
    </a>
    {% endif %}
    {% if session.role != 'caseworker' %}
    <a href="{{ url_for('add_client') }}" class="btn-primary">
      <i class="fas fa-plus"></i> Assessment
    </a>
    {% endif %}
  </div>
</div>

<!-- Filters moved inside the card below -->

<div class="card">
  <div class="table-header-bar">
    <h2 class="table-title">Client</h2>
    <div class="header-controls">
      <div class="date-input">
        <i class="far fa-calendar"></i>
        <input type="text" placeholder="dd/mm/yyyy" aria-label="From date" />
        <span class="date-label">From</span>
      </div>
      <div class="date-input">
        <i class="far fa-calendar"></i>
        <input type="text" placeholder="dd/mm/yyyy" aria-label="To date" />
        <span class="date-label">To</span>
      </div>
      <div class="filter-input" data-label="Status">
        <select class="filter-select" data-filter="status">
          <option value="all">All</option>
          <option value="active">Active</option>
          <option value="relapsed">Relapsed</option>
          <option value="review">Review</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <div class="filter-input" data-label="Care Type">
        <select class="filter-select" data-filter="care_type">
          <option value="all">All</option>
          <option value="in_house">In House</option>
          <option value="after_care">After Care</option>
        </select>
      </div>
      <div class="export-dropdown">
        <button class="btn-export" id="exportDropdownBtn">
          <i class="fas fa-download"></i> Export
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="export-menu" id="exportMenu">
          <button class="export-item" data-export="filtered">
            Export Filtered Data
          </button>
          <button class="export-item" data-export="all">
            Export All to Excel
          </button>
          <button class="export-item" data-export="status">
            Export by Status
          </button>
          <button class="export-item" data-export="care_type">
            Export by Care Type
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Pagination Info -->
  {% if pagination.total > 0 %}
  <div class="pagination-info">
    <p>
      Showing {{ pagination.start_record }}-{{ pagination.end_record }} of {{
      pagination.total }} clients
    </p>
  </div>
  {% endif %}

  <div class="table-container">
    <table class="clients-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Age</th>
          <th>Gender</th>
          <th>Address</th>
          <th>Care Type</th>
          <th>Stage</th>
          <th>Last Check-in</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if clients and clients|length > 0 %} {% for client in clients %}
        <tr data-client-id="{{ client.id }}">
          <td>{{ client.clientId or 'â€”' }}</td>
          <td>{{ client.name }}</td>
          <td>{{ client.age }}</td>
          <td>{{ client.gender|title }}</td>
          <td>{{ client.address }}</td>
          <td>
            <span
              class="care-type-badge care-type-{{ client.care_type }}"
              data-care-type="{{ client.care_type }}"
            >
              {{ client.care_type|replace('_', ' ')|title }}
            </span>
          </td>
          <td>
            <span
              class="stage-badge stage-{{ client.status|lower }}"
              data-status="{{ client.status|lower }}"
            >
              {% if client.status == 'pending' %}
                <i class="fas fa-clock"></i> Pending
              {% elif client.status == 'rejected' %}
                <i class="fas fa-times"></i> Rejected
              {% elif client.status == 'completed' %}
                <i class="fas fa-check-circle"></i> Completed
              {% elif client.status == 'ready_for_aftercare' %}
                <i class="fas fa-arrow-right"></i> Ready for Aftercare
              {% elif client.status == 'pending_aftercare' %}
                <i class="fas fa-clock"></i> Pending Aftercare
              {% else %}
                {{ client.status|title }}
              {% endif %}
            </span>
          </td>
          <td>{{ client.checkInDate }}</td>
          <td class="actions-cell">
            <a
              href="{{ url_for('client_profile', client_id=client.id) }}"
              class="action-btn"
              title="View Profile"
            >
              <i class="fas fa-user"></i>
            </a>
            
            <!-- Send to Aftercare button for completed clients -->
            {% if client.status == 'completed' and client.care_type == 'in_house' and session.role in ['admin', 'facilitator'] %}
            <button
              class="action-btn aftercare-btn"
              title="Send to Aftercare"
              onclick="sendToAftercare('{{ client.id }}', '{{ client.name|e }}')"
            >
              <i class="fas fa-arrow-right"></i>
            </button>
            {% endif %}
            
            <button
              class="action-btn"
              title="Archive"
              onclick="openArchiveModal('{{ client.id }}', '{{ client.name|e }}')"
            >
              <i class="fas fa-archive"></i>
            </button>
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="9" class="no-data">
            <div class="no-data-message">
              <i class="fas fa-users"></i>
              <p>No clients found</p>
              {% if session.role == 'admin' %}
              <p class="text-muted">Check the Pending Clients page for clients awaiting approval.</p>
              <a href="{{ url_for('pending_clients') }}" class="btn-secondary">
                <i class="fas fa-clock"></i> View Pending Clients
              </a>
              {% endif %}
              <a href="{{ url_for('add_client') }}" class="btn-primary">
                <i class="fas fa-plus"></i> Add Your First Client
              </a>
            </div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  {% if pagination.total_pages > 1 %}
  <div class="pagination-container">
    <div class="pagination">
      <!-- Previous Button -->
      {% if pagination.has_prev %}
      <a
        href="{{ url_for('clients', page=pagination.prev_num) }}"
        class="pagination-btn"
      >
        <i class="fas fa-chevron-left"></i> Previous
      </a>
      {% else %}
      <span class="pagination-btn disabled">
        <i class="fas fa-chevron-left"></i> Previous
      </span>
      {% endif %}

      <!-- Page Numbers -->
      <div class="pagination-numbers">
        {% for page_num in range(1, pagination.total_pages + 1) %} {% if
        page_num == pagination.page %}
        <span class="pagination-number active">{{ page_num }}</span>
        {% elif page_num <= 2 or page_num >= pagination.total_pages - 1 or
        (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
        <a
          href="{{ url_for('clients', page=page_num) }}"
          class="pagination-number"
          >{{ page_num }}</a
        >
        {% elif page_num == 3 and pagination.page > 4 %}
        <span class="pagination-ellipsis">...</span>
        {% elif page_num == pagination.total_pages - 2 and pagination.page <
        pagination.total_pages - 3 %}
        <span class="pagination-ellipsis">...</span>
        {% endif %} {% endfor %}
      </div>

      <!-- Next Button -->
      {% if pagination.has_next %}
      <a
        href="{{ url_for('clients', page=pagination.next_num) }}"
        class="pagination-btn"
      >
        Next <i class="fas fa-chevron-right"></i>
      </a>
      {% else %}
      <span class="pagination-btn disabled">
        Next <i class="fas fa-chevron-right"></i>
      </span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Archive Confirmation Modal -->
<div id="archiveModal" class="modal">
  <div class="modal-content" style="max-width: 480px">
    <div class="modal-header">
      <div class="modal-title">
        <h3>Archive Client</h3>
        <span class="modal-date">This action can be undone by admins.</span>
      </div>
      <button class="modal-close" onclick="closeArchiveModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p id="archiveText">Are you sure you want to archive this client?</p>
    </div>
    <div class="modal-footer">
      <div class="action-buttons">
        <button class="btn-secondary" onclick="closeArchiveModal()">
          Cancel
        </button>
        <button class="btn-primary" id="confirmArchiveBtn">Archive</button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/clients.js') }}"></script>
<script>
  // Export dropdown toggle (UI only)
  (function () {
    const btn = document.getElementById("exportDropdownBtn");
    const menu = document.getElementById("exportMenu");
    if (btn && menu) {
      btn.addEventListener("click", function (e) {
        e.stopPropagation();
        menu.classList.toggle("active");
      });
      document.addEventListener("click", function () {
        menu.classList.remove("active");
      });
    }
  })();

  let archiveClientId = null;
  function openArchiveModal(id, name) {
    archiveClientId = id;
    const modal = document.getElementById("archiveModal");
    const text = document.getElementById("archiveText");
    if (text) {
      text.textContent = `Are you sure you want to archive "${name}"?`;
    }
    if (modal) {
      modal.classList.add("active");
    }
  }
  function closeArchiveModal() {
    const modal = document.getElementById("archiveModal");
    if (modal) {
      modal.classList.remove("active");
    }
    archiveClientId = null;
  }
  document
    .getElementById("confirmArchiveBtn")
    ?.addEventListener("click", async function () {
      if (!archiveClientId) return;
      try {
        const response = await fetch(`/clients/${archiveClientId}/archive`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });
        const result = await response.json();
        if (result.success) {
          const row = document.querySelector(
            `[data-client-id="${archiveClientId}"]`
          );
          if (row) {
            row.classList.add("fade-out");
            setTimeout(() => row.remove(), 300);
          }
        } else {
          alert(result.error || "Failed to archive client");
        }
      } catch (e) {
        console.error(e);
        alert("Failed to archive client");
      } finally {
        closeArchiveModal();
      }
    });
  
  // Send to aftercare function
  function sendToAftercare(clientId, clientName) {
    if (confirm(`Are you sure you want to send "${clientName}" to aftercare? This will create a request for admin approval.`)) {
      fetch(`/clients/${clientId}/send-to-aftercare`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          alert(result.message);
          // Reload the page to show updated status
          location.reload();
        } else {
          alert(result.error || "Failed to send to aftercare");
        }
      })
      .catch(e => {
        console.error(e);
        alert("Failed to send to aftercare");
      });
    }
  }
</script>
{% endblock %}
