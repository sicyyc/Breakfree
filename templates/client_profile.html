{% extends "base.html" %}

{% block title %}Client Profile - BreakFree{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/client_profile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/client_notes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/charts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/activity.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/progress.css') }}">
{% endblock %}

{% block content %}
<div class="back-button">
    <a href="{{ url_for('clients') }}" class="btn-link">
        <i class="fas fa-arrow-left"></i>
        Back to Clients
    </a>
</div>
<div class="main-header" data-client-id="{{ client.id }}" data-client-status="{{ client.status }}" data-client-care-type="{{ client.care_type }}">
    <div class="client-header">
        <div class="client-info-section">
            <div class="client-image">
                {% if client.image_url %}
                    <img src="{{ url_for('static', filename=client.image_url) }}" alt="{{ client.name }}">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default-avatar.png') }}" alt="{{ client.name }}">
                {% endif %}
            </div>
            <div class="client-info">
                <h1>{{ client.name }}</h1>
                <div class="client-meta">
                    <span class="client-id">ID: {{ client.id }}</span>
                    <div class="client-status-section">
                        <span class="status-badge {{ client.status.lower() }}">
                            <i class="fas fa-circle"></i>
                            {{ client.status }}
                        </span>
                        <span class="care-type-badge care-type-{{ client.care_type }}">
                            <i class="fas fa-home"></i>
                            {{ client.care_type|replace('_', ' ')|title }}
                        </span>
                    </div>
                    
                    <!-- Rejection Reason Display -->
                    {% if client.status == 'rejected' and client.rejection_reason %}
                    <div class="rejection-info">
                        <div class="rejection-reason">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Rejection Reason:</strong> {{ client.rejection_reason }}
                        </div>
                        {% if client.rejected_at %}
                        <div class="rejection-date">
                            <i class="fas fa-calendar"></i>
                            <strong>Rejected on:</strong> {{ client.rejected_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Aftercare Rejection Reason Display -->
                    {% if client.aftercare_rejection_reason %}
                    <div class="rejection-info aftercare-rejection">
                        <div class="rejection-reason">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Aftercare Rejection Reason:</strong> {{ client.aftercare_rejection_reason }}
                        </div>
                        {% if client.aftercare_rejected_date %}
                        <div class="rejection-date">
                            <i class="fas fa-calendar"></i>
                            <strong>Aftercare rejected on:</strong> {{ client.aftercare_rejected_date.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-secondary" id="editClientBtn">
                <i class="fas fa-edit"></i>
                Edit Profile
            </button>
            
            
            <!-- Progress and Aftercare Actions -->
            {% if client.care_type == 'in_house' and client.status == 'active' %}
                {% if session.role in ['admin', 'facilitator'] %}
                <button class="btn-success" id="completeTreatmentBtn" onclick="completeTreatment('{{ client.id }}', '{{ client.name|e }}')" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    Complete Treatment
                </button>
                {% endif %}
            {% endif %}
            
            {% if client.status == 'completed' %}
                {% if session.role == 'admin' %}
                <button class="btn-warning" id="sendToAftercareBtn" onclick="sendToAftercare('{{ client.id }}', '{{ client.name|e }}')">
                    <i class="fas fa-arrow-right"></i>
                    Send to Aftercare
                </button>
                {% endif %}
            {% endif %}
            
            {% if client.care_type == 'after_care' %}
                <span class="status-badge aftercare-badge">
                    <i class="fas fa-home"></i>
                    In Aftercare System
                </span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" data-tab="personal-info">
        <i class="fas fa-user"></i>
        Personal Info
    </button>

    <button class="tab-button" data-tab="assessment">
        <i class="fas fa-clipboard-check"></i>
        Assessment
    </button>
    {% if client.status != 'rejected' %}
    <button class="tab-button" data-tab="intervention">
        <i class="fas fa-bullseye"></i>
        Intervention
    </button>
    {% endif %}
    <button class="tab-button" data-tab="progress">
        <i class="fas fa-chart-line"></i>
        Progress
    </button>
    <button class="tab-button" data-tab="notes">
        <i class="fas fa-sticky-note"></i>
        Notes
    </button>
</div>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Personal Info Tab -->
    <div class="tab-pane active" id="personal-info">
        <div class="profile-grid">
            <!-- Personal Information Card -->
            <div class="card info-card">
                <div class="card-header">
                    <h3><i class="far fa-user"></i> Personal Information</h3>
                    <div class="header-actions">
                        <button class="btn-edit" title="Edit" data-edit-section="personal" data-client-id="{{ client.id }}">
                            <i class="far fa-edit"></i>
                            Edit
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-grid">
                        <!-- Ordered Basic Information (no separators) -->
                        
                        <div class="info-item">
                            <label>Surname</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-id-card"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="surname" title="Click to edit">{{ client.surname or 'Not provided' }}</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>First Name</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-id-card"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="firstName" title="Click to edit">{{ client.firstName or 'Not provided' }}</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Middle Initial</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-id-card"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="middleInitial" title="Click to edit">{{ client.middleInitial or 'Not provided' }}</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Suffix</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-id-card"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="suffix" title="Click to edit">{{ client.suffix or 'Not provided' }}</div>
                            </div>
                        </div>
                        {% if client.birthday or client.date_of_birth or client.birthdate %}
                        <div class="info-item">
                            <label>Birth Date</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-birthday-cake"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="birthdate" title="Click to edit">{{ client.birthday or client.date_of_birth or client.birthdate }}</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <label>Age</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-calendar-alt"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="age" title="Click to edit">{{ client.age }}</div>
                            </div>
                        </div>
                        {% if client.civil_status %}
                        <div class="info-item">
                            <label>Civil Status</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="civil_status" title="Click to edit">{{ client.civil_status|title }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.spouse_name %}
                        <div class="info-item">
                            <label>Spouse Name</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="spouse_name" title="Click to edit">{{ client.spouse_name }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.years_married %}
                        <div class="info-item">
                            <label>Years Married</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-calendar-heart"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="years_married" title="Click to edit">{{ client.years_married }} years</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.number_of_children %}
                        <div class="info-item">
                            <label>Number of Children</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-baby"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="number_of_children" title="Click to edit">{{ client.number_of_children }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.relationship_with_children %}
                        <div class="info-item">
                            <label>Relationship with Children</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-children"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="relationship_with_children" title="Click to edit">{{ client.relationship_with_children }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.mother_name %}
                        <div class="info-item">
                            <label>Mother's Name</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-female"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="mother_name" title="Click to edit">{{ client.mother_name }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.relationship_with_mother %}
                        <div class="info-item">
                            <label>Relationship with Mother</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-hand-holding-heart"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="relationship_with_mother" title="Click to edit">{{ client.relationship_with_mother }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.father_name %}
                        <div class="info-item">
                            <label>Father's Name</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-male"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="father_name" title="Click to edit">{{ client.father_name }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.relationship_with_father %}
                        <div class="info-item">
                            <label>Relationship with Father</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-handshake"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="relationship_with_father" title="Click to edit">{{ client.relationship_with_father }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.number_of_siblings %}
                        <div class="info-item">
                            <label>Number of Siblings</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="number_of_siblings" title="Click to edit">{{ client.number_of_siblings }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.birth_order %}
                        <div class="info-item">
                            <label>Birth Order</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-sort-numeric-up"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="birth_order" title="Click to edit">{{ client.birth_order }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if client.relationship_with_siblings %}
                        <div class="info-item">
                            <label>Relationship with Siblings</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="fas fa-people-arrows"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="relationship_with_siblings" title="Click to edit">{{ client.relationship_with_siblings }}</div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Additional contact/program info (kept without separators) -->

                        {% if client.gender %}
                        <div class="info-item">
                            <label>Gender</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-venus-mars"></i>
                                </div>
                                <div class="field-value">{{ client.gender|title }}</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <label>Address</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-map-marker-alt"></i>
                                </div>
                                <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="address" title="Click to edit">{{ client.address if client.address else 'Not provided' }}</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Registration Date</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-calendar-plus"></i>
                                </div>
                                <div class="field-value">
                                    {% if client.registrationDate %}
                                        {{ client.registrationDate }}
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Check-in Date</label>
                            <div class="field-input">
                                <div class="field-icon">
                                    <i class="far fa-calendar-check"></i>
                                </div>
                                <div class="field-value">
                                    {% if client.checkInDate %}
                                        {{ client.checkInDate }}
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <!-- Assessment Tab -->
    <div class="tab-pane" id="assessment">
        <div class="profile-grid">
            <!-- Assessment Information Card -->
            <div class="card info-card">
                <div class="card-header">
                    <h3><i class="fas fa-clipboard-check"></i> Assessment Information</h3>
                </div>
                <div class="card-content">
                    
                    <!-- Education Assessment Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-graduation-cap"></i> Education Assessment</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Education" data-edit-section="education" data-client-id="{{ client.id }}">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        {% if client.elementary_school or client.secondary_school or client.college or client.education_completed or client.reason_for_incomplete %}
                        <div class="info-grid">
                            {% if client.elementary_school %}
                            <div class="info-item">
                                <label>Elementary School</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-school"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="elementary_school" title="Click to edit">{{ client.elementary_school }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.secondary_school %}
                            <div class="info-item">
                                <label>Secondary School</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="secondary_school" title="Click to edit">{{ client.secondary_school }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.college %}
                            <div class="info-item">
                                <label>College/University</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="college" title="Click to edit">{{ client.college }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.education_completed %}
                            <div class="info-item">
                                <label>Education Completed</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-certificate"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="education_completed" title="Click to edit">{{ client.education_completed|replace('_', ' ')|title }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.reason_for_incomplete %}
                            <div class="info-item">
                                <label>Reason for Incomplete Education</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="reason_for_incomplete" title="Click to edit">{{ client.reason_for_incomplete }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data-message">
                            <p><i class="fas fa-info-circle"></i> No education assessment data available for this client.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Work Experience Assessment Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-briefcase"></i> Work Experience Assessment</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Work Experience" data-edit-section="work" data-client-id="{{ client.id }}">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        {% if client.work_experience %}
                        <div class="info-grid">
                            {% if client.work_experience %}
                            <div class="info-item">
                                <label>Work Experience</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-briefcase"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="work_experience" title="Click to edit">{{ client.work_experience }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data-message">
                            <p><i class="fas fa-info-circle"></i> No work experience assessment data available for this client.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Drug Usage Assessment Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-heartbeat"></i> Drug Usage Assessment</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Drug Usage" data-edit-section="drug" data-client-id="{{ client.id }}">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        {% if client.drug_usage_amount or client.drug_effects or client.last_drug_use or client.why_rehabilitation %}
                        <div class="info-grid">
                            {% if client.drug_usage_amount %}
                            <div class="info-item">
                                <label>Drug Usage Amount & Frequency</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-pills"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_usage_amount" title="Click to edit">{{ client.drug_usage_amount }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.drug_effects %}
                            <div class="info-item">
                                <label>Drug Effects</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_effects" title="Click to edit">{{ client.drug_effects }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.drug_impact %}
                            <div class="info-item">
                                <label>Impact on Life</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-life-ring"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_impact" title="Click to edit">{{ client.drug_impact }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.last_drug_use %}
                            <div class="info-item">
                                <label>Last Drug Use</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-calendar-times"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="last_drug_use" title="Click to edit">{{ client.last_drug_use }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.first_drug_use %}
                            <div class="info-item">
                                <label>First Drug Use</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-calendar-plus"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="first_drug_use" title="Click to edit">{{ client.first_drug_use }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.drug_types %}
                            <div class="info-item">
                                <label>Drug Types Used</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-list"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_types" title="Click to edit">{{ client.drug_types }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.drug_reasons %}
                            <div class="info-item">
                                <label>Reasons for Drug Use</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_reasons" title="Click to edit">{{ client.drug_reasons }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.drug_duration %}
                            <div class="info-item">
                                <label>Duration of Drug Use</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="drug_duration" title="Click to edit">{{ client.drug_duration }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.why_rehabilitation %}
                            <div class="info-item">
                                <label>Reason for Rehabilitation</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="why_rehabilitation" title="Click to edit">{{ client.why_rehabilitation }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.wants_rehabilitation %}
                            <div class="info-item">
                                <label>Wants Rehabilitation</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="wants_rehabilitation" title="Click to edit">{{ client.wants_rehabilitation|title }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.previous_rehabilitation %}
                            <div class="info-item">
                                <label>Previous Rehabilitation</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="previous_rehabilitation" title="Click to edit">{{ client.previous_rehabilitation|title }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.previous_rehabilitation_location %}
                            <div class="info-item">
                                <label>Previous Rehabilitation Location</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="previous_rehabilitation_location" title="Click to edit">{{ client.previous_rehabilitation_location }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.rehabilitation_goals %}
                            <div class="info-item">
                                <label>Rehabilitation Goals</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-bullseye"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="rehabilitation_goals" title="Click to edit">{{ client.rehabilitation_goals }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data-message">
                            <p><i class="fas fa-info-circle"></i> No drug usage assessment data available for this client.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Rehabilitation Assessment Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-brain"></i> Rehabilitation Assessment</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Rehabilitation" data-edit-section="rehab" data-client-id="{{ client.id }}">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        {% if client.mentalHealthConditions or client.currentMood or client.stressLevel %}
                        <div class="info-grid">
                            {% if client.mentalHealthConditions and client.mentalHealthConditions is iterable %}
                            <div class="info-item">
                                <label>Mental Health Conditions</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="field-value">
                                        {% for condition in client.mentalHealthConditions %}
                                            <span class="badge">{{ condition|replace('_', ' ')|title }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.mentalHealthNotes %}
                            <div class="info-item">
                                <label>Mental Health Notes</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-sticky-note"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="mentalHealthNotes" title="Click to edit">{{ client.mentalHealthNotes }}</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.currentMood %}
                            <div class="info-item">
                                <label>Current Mood</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-smile"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="currentMood" title="Click to edit">{{ client.currentMood }}/5</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if client.stressLevel %}
                            <div class="info-item">
                                <label>Stress Level</label>
                                <div class="field-input">
                                    <div class="field-icon">
                                        <i class="fas fa-tachometer-alt"></i>
                                    </div>
                                    <div class="field-value editable-field" data-client-id="{{ client.id }}" data-field="stressLevel" title="Click to edit">{{ client.stressLevel }}/5</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data-message">
                            <p><i class="fas fa-info-circle"></i> No rehabilitation assessment data available for this client.</p>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Intervention Tab -->
    {% if client.status != 'rejected' %}
    <div class="tab-pane" id="intervention">
        <div class="profile-grid">
            <!-- Intervention Information Card -->
            <div class="card info-card">
                <div class="card-header">
                    <h3><i class="fas fa-bullseye"></i> Intervention Services</h3>
                </div>
                <div class="card-content">
                    
                    <!-- Social Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-users"></i> Social Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Social Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To provide comprehensive social support and community integration</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Social skills training</li>
                                    <li>Community integration programs</li>
                                    <li>Family counseling and support</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Social Worker</li>
                                    <li>Client</li>
                                    <li>Family Members</li>
                                    <li>Community Volunteers</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Improved social skills and relationships</li>
                                    <li>Better family dynamics</li>
                                    <li>Community reintegration</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Ongoing throughout treatment</li>
                                        <li>Weekly sessions</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 75%"></div>
                                        </div>
                                        <span class="progress-percentage">75%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Homelife Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-home"></i> Homelife Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Homelife Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To develop essential life skills for independent living</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Daily living skills training</li>
                                    <li>Household management</li>
                                    <li>Personal hygiene and self-care</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Houseparent</li>
                                    <li>Client</li>
                                    <li>Life Skills Trainer</li>
                                    <li>Support Staff</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Independent living capabilities</li>
                                    <li>Improved self-care habits</li>
                                    <li>Responsible household management</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Daily activities</li>
                                        <li>Continuous throughout stay</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 85%"></div>
                                        </div>
                                        <span class="progress-percentage">85%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Educational Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-graduation-cap"></i> Educational Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Educational Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To provide educational opportunities and academic support</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Basic literacy and numeracy</li>
                                    <li>Continuing education programs</li>
                                    <li>Computer skills training</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Educational Coordinator</li>
                                    <li>Teachers/Tutors</li>
                                    <li>Client</li>
                                    <li>Academic Support Staff</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Improved academic skills</li>
                                    <li>Enhanced learning capabilities</li>
                                    <li>Educational advancement</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Regular classes</li>
                                        <li>Individual tutoring as needed</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 70%"></div>
                                        </div>
                                        <span class="progress-percentage">70%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Psychological Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-brain"></i> Psychological Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Psychological Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To address mental health needs and provide psychological support</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Individual counseling sessions</li>
                                    <li>Group therapy</li>
                                    <li>Behavioral therapy</li>
                                    <li>Mental health assessment</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Psychologist</li>
                                    <li>Psychiatrist</li>
                                    <li>Mental Health Counselor</li>
                                    <li>Client</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Improved mental health</li>
                                    <li>Better coping mechanisms</li>
                                    <li>Emotional stability</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Weekly sessions</li>
                                        <li>As needed assessment</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 80%"></div>
                                        </div>
                                        <span class="progress-percentage">80%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Health Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-heartbeat"></i> Health Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Health Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To ensure physical health and well-being</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Regular health check-ups</li>
                                    <li>Medical treatment and monitoring</li>
                                    <li>Nutrition and diet management</li>
                                    <li>Physical fitness programs</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Medical Doctor</li>
                                    <li>Nurse</li>
                                    <li>Nutritionist</li>
                                    <li>Client</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Improved physical health</li>
                                    <li>Better nutrition habits</li>
                                    <li>Regular health monitoring</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Regular check-ups</li>
                                        <li>Daily health monitoring</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 95%"></div>
                                        </div>
                                        <span class="progress-percentage">95%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Economics and Livelihood Projects Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-briefcase"></i> Economics and Livelihood Projects</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Economics and Livelihood">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To help acquire employable skills and provide trainings that will help improve skills and ability</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Involvement in skills training (gardening, farming, weaving)</li>
                                    <li>Involvement in dishwashing liquid making</li>
                                    <li>Vocational training programs</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Client</li>
                                    <li>Houseparent</li>
                                    <li>Staffs</li>
                                    <li>Trainor's/Lecturers</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Generation of income while inside the rehabilitation center</li>
                                    <li>Acquisition of skills that can be used for future income</li>
                                    <li>Employment readiness</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Entire stay in the rehabilitation center</li>
                                        <li>To be scheduled</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="overallProgressFill" style="width: 0%"></div>
                                        </div>
                                        <span class="progress-percentage" id="overallProgressText">0%</span>
                                    </div>
                                    <div class="progress-details">
                                        <div class="progress-metric">
                                            <span class="metric-label">Engagement:</span>
                                            <span class="metric-value" id="engagementScore">Loading...</span>
                                        </div>
                                        <div class="progress-metric">
                                            <span class="metric-label">Risk Level:</span>
                                            <span class="metric-value risk-level risk-low" id="riskLevel">Loading...</span>
                                        </div>
                                        <div class="progress-metric">
                                            <span class="metric-label">Days in Treatment:</span>
                                            <span class="metric-value" id="daysInTreatment">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Recreational Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-gamepad"></i> Recreational Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Recreational Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To promote physical, mental, social, and cultural development and harness hidden talents</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Involvement in daily exercise</li>
                                    <li>Involvement in recreational activities (Family Day, Sportsfest)</li>
                                    <li>Arts and crafts activities</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Client</li>
                                    <li>Social Worker</li>
                                    <li>Psychometrician</li>
                                    <li>Houseparent</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>To maintain his physical health through exercise</li>
                                    <li>Improvement of self-confidence</li>
                                    <li>Development of talents and skills</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>Entire stay in the rehabilitation center</li>
                                        <li>Everyday, As scheduled</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 90%"></div>
                                        </div>
                                        <span class="progress-percentage">90%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="info-separator"></div>

                    <!-- Spiritual Service Section -->
                    <div class="assessment-section">
                        <div class="section-header">
                            <h4><i class="fas fa-pray"></i> Spiritual Service</h4>
                            <div class="section-actions">
                                <button class="btn-edit" title="Edit Spiritual Service">
                                    <i class="far fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Grid Boxes -->
                        <div class="service-info-grid">
                            <div class="info-block">
                                <label>Objective</label>
                                <p>To strengthen and deepen faith in God</p>
                            </div>
                            <div class="info-block">
                                <label>Activities</label>
                                <ul>
                                    <li>Involvement in spiritual activities (daily rosary, Sunday mass)</li>
                                    <li>Bible sharing and religious practices</li>
                                    <li>Spiritual counseling</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Responsible Person</label>
                                <ul>
                                    <li>Client</li>
                                    <li>Social Worker</li>
                                    <li>Houseparent</li>
                                    <li>Priest</li>
                                    <li>Spiritual Groups</li>
                                </ul>
                            </div>
                            <div class="info-block">
                                <label>Expected Output</label>
                                <ul>
                                    <li>Deepen his faith and recognize that God cares for him</li>
                                    <li>Development of strength whenever in a life crisis</li>
                                    <li>Spiritual growth and peace</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Bottom Fields -->
                        <div class="bottom-fields">
                            <div class="field-row">
                                <div class="info-block timeframe-block">
                                    <label>Timeframe</label>
                                    <ul>
                                        <li>As scheduled</li>
                                        <li>Regular spiritual activities</li>
                                    </ul>
                                </div>
                                <div class="progress-block">
                                    <label class="progress-label">Progress</label>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 60%"></div>
                                        </div>
                                        <span class="progress-percentage">60%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Progress Tab -->
    <div class="tab-pane" id="progress">
        <div class="profile-grid">
            <!-- Progress Overview Card -->
            <div class="card progress-overview-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Progress Overview</h3>
                    <div class="header-actions">
                        <div class="period-selector">
                            <button class="btn-text active" data-period="weekly">Weekly</button>
                            <button class="btn-text" data-period="monthly">Monthly</button>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="progress-insights" id="progressInsights">
                        <!-- Progress insights will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sentiment Trend Chart Card -->
            <div class="card sentiment-chart-card">
                <div class="card-header">
                    <h3><i class="fas fa-heart"></i> Sentiment Trend</h3>
                    <div class="header-actions">
                        <div class="chart-period-selector">
                            <button class="btn-text active" data-chart-period="weekly">Weekly</button>
                            <button class="btn-text" data-chart-period="monthly">Monthly</button>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Domain Breakdown Chart Card -->
            <div class="card domain-chart-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-bar"></i> Domain Analysis</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="domainChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Keywords Word Cloud Card -->
            <div class="card keywords-card">
                <div class="card-header">
                    <h3><i class="fas fa-tags"></i> Top Keywords</h3>
                </div>
                <div class="card-content">
                    <div class="keywords-cloud" id="keywordsCloud">
                        <!-- Keywords will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Tab -->
    <div class="tab-pane" id="notes">
        <div class="profile-grid">
            <!-- Notes Card -->
            <div class="card notes-card">
                <div class="card-header">
                    <h3><i class="fas fa-sticky-note"></i>  Notes and Observations</h3>
                    <div class="header-actions">
                        <div class="notes-filters">
                            <select id="sentimentFilter" class="filter-select">
                                <option value="">All Sentiments</option>
                                <option value="positive">Positive</option>
                                <option value="neutral">Neutral</option>
                                <option value="negative">Negative</option>
                            </select>
                            <select id="domainFilter" class="filter-select">
                                <option value="">All Domains</option>
                                <option value="emotional">Emotional</option>
                                <option value="cognitive">Cognitive</option>
                                <option value="social">Social</option>
                            </select>
                            <input type="text" id="keywordSearch" placeholder="Search keywords..." class="search-input">
                        </div>
                        <button class="btn-edit" id="addNoteBtn" title="Add Note">
                            <i class="fas fa-plus"></i>
                            Add Note
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="notes-list" id="notesList">
                        <!-- Notes will be loaded dynamically -->
                    </div>
                    
                    <!-- No notes message (hidden when notes exist) -->
                    <div class="no-data-message" id="noNotesMessage" style="display: none;">
                        <p>
                            <i class="fas fa-sticky-note"></i>
                            No notes have been added yet. Click "Add Note" to create the first note.
                        </p>
                    </div>
                    
                    <!-- Loading message -->
                    <div class="loading-message" id="notesLoading" style="display: none;">
                        <p><i class="fas fa-spinner fa-spin"></i> Loading notes...</p>
                    </div>
                </div>
            </div>
            
            <!-- NLP Analysis Summary Card -->
            <div class="card nlp-summary-card">
                <div class="card-header">
                    <h3><i class="fas fa-brain"></i>  NLP Analysis Summary</h3>
                </div>
                <div class="card-content">
                    <div class="nlp-summary" id="nlpSummary">
                        <!-- NLP analysis will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Add Note Modal - Moved outside tab content for better accessibility -->
<div id="addNoteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-sticky-note"></i> Add New Note <small style="color: #666; font-weight: normal;">(with user tracking)</small></h3>
            <span class="close" id="closeNoteModal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addNoteForm">
                <div class="form-group">
                    <label for="noteText">Note Content</label>
                    <textarea id="noteText" placeholder="Enter your observation about the client..." rows="6" required></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span> characters
                    </div>
                </div>
                
                <!-- Real-time NLP Analysis Preview -->
                <div class="nlp-preview" id="nlpPreview" style="display: none;">
                    <h4><i class="fas fa-brain"></i> Live Analysis Preview</h4>
                    <div class="preview-content">
                        <div class="preview-sentiment" id="previewSentiment">
                            <span class="preview-label">Sentiment:</span>
                            <span class="sentiment-preview" id="sentimentPreview">Analyzing...</span>
                        </div>
                        <div class="preview-keywords" id="previewKeywords">
                            <span class="preview-label">Keywords:</span>
                            <div class="keywords-preview" id="keywordsPreview"></div>
                        </div>
                        <div class="preview-domains" id="previewDomains">
                            <span class="preview-label">Domain Analysis:</span>
                            <div class="domains-preview" id="domainsPreview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelNoteBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveNoteBtn">
                        <i class="fas fa-save"></i> Save Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/client_profile.js') }}"></script>
<script src="{{ url_for('static', filename='js/progress.js') }}"></script>
<script>
// Treatment completion and aftercare transfer functions
function completeTreatment(clientId, clientName) {
    // Get current progress to show in confirmation
    const progressElement = document.getElementById('overallProgressStat');
    const currentProgress = progressElement ? progressElement.textContent : 'Unknown';
    
    const confirmMessage = `Are you sure you want to mark treatment as completed for "${clientName}"?\n\nCurrent Progress: ${currentProgress}`;
    
    if (confirm(confirmMessage)) {
        fetch(`/clients/${clientId}/complete-treatment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ force_completion: false })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                // Reload the page to show updated status
                location.reload();
            } else {
                // Check if force completion is required
                if (result.requires_force) {
                    const forceConfirm = confirm(`${result.error}\n\nDo you want to force complete the treatment anyway?`);
                    if (forceConfirm) {
                        // Force complete the treatment
                        fetch(`/clients/${clientId}/complete-treatment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ force_completion: true })
                        })
                        .then(response => response.json())
                        .then(forceResult => {
                            if (forceResult.success) {
                                alert('Treatment completed successfully (forced completion)');
                                location.reload();
                            } else {
                                alert(forceResult.error || 'Failed to force complete treatment');
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            alert('Failed to force complete treatment');
                        });
                    }
                } else {
                    alert(result.error || 'Failed to complete treatment');
                }
            }
        })
        .catch(e => {
            console.error(e);
            alert('Failed to complete treatment');
        });
    }
}

function sendToAftercare(clientId, clientName) {
    if (confirm(`Are you sure you want to send "${clientName}" to the aftercare system?`)) {
        fetch(`/clients/${clientId}/send-to-aftercare`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                // Reload the page to show updated status
                location.reload();
            } else {
                alert(result.error || 'Failed to send to aftercare');
            }
        })
        .catch(e => {
            console.error(e);
            alert('Failed to send to aftercare');
        });
    }
}

// Progress tracking will be implemented here
let currentClientId = '{{ client.id }}';

// BULLETPROOF ADD NOTE MODAL - WORKS 100%
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up add note modal...');
    
    // Get client ID
    const mainHeader = document.querySelector('.main-header');
    const clientId = mainHeader ? mainHeader.getAttribute('data-client-id') : null;
    console.log('Client ID:', clientId);
    
    // Function to show modal
    function showModal() {
        console.log('showModal() function called');
        const modal = document.getElementById('addNoteModal');
        console.log('Modal element:', modal);
        if (modal) {
            console.log('Modal found, showing...');
            
            // Force all modal styles
            modal.style.cssText = `
                display: flex !important;
                opacity: 1 !important;
                visibility: visible !important;
                z-index: 9999 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0,0,0,0.5) !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            
            document.body.style.overflow = 'hidden';
            console.log('Modal shown! Display:', modal.style.display, 'Opacity:', modal.style.opacity);
            
            // Double-check after a small delay
            setTimeout(() => {
                console.log('Modal check after delay - Display:', modal.style.display, 'Visible:', modal.offsetParent !== null);
            }, 100);
        } else {
            console.error('Modal not found!');
        }
    }
    
    // Function to hide modal
    function hideModal() {
        const modal = document.getElementById('addNoteModal');
        if (modal) {
            modal.style.display = 'none';
            modal.style.opacity = '0';
            document.body.style.overflow = 'auto';
            // Reset form
            const form = document.getElementById('addNoteForm');
            if (form) form.reset();
            console.log('Modal hidden!');
        }
    }
    
    // Function to handle form submission
    async function handleSubmit(e) {
        e.preventDefault();
        console.log('Form submitted!');
        
        const noteText = document.getElementById('noteText').value.trim();
        
        if (!noteText) {
            alert('Please enter note content');
            return;
        }
        
        if (!clientId) {
            alert('Client ID not found');
            return;
        }
        
        const saveBtn = document.getElementById('saveNoteBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        
        try {
            console.log('Sending note to server:', { text: noteText });
            const response = await fetch(`/clients/${clientId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: noteText })
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (response.ok) {
                hideModal();
                // Show success message with analysis info
                const sentiment = data.analysis?.sentiment?.sentiment || 'neutral';
                const keywords = data.analysis?.keywords?.slice(0, 3).join(', ') || 'none';
                const author = data.analysis?.author?.email || 'You';
                alert(`Note added successfully!\n\nAuthor: ${author}\nAnalysis:\n• Sentiment: ${sentiment}\n• Keywords: ${keywords}\n\nThe note has been saved and analyzed.`);
                // Reload notes and NLP summary instead of full page reload
                loadNotes();
                loadNLPSummary();
            } else {
                console.error('Server error:', data);
                let errorMessage = 'Failed to add note';
                if (data.error) {
                    if (data.error.includes('Client not found')) {
                        errorMessage = 'Client not found. Please refresh the page and try again.';
                    } else if (data.error.includes('NLP analysis failed')) {
                        errorMessage = 'Analysis failed. Please try again with different text.';
                    } else if (data.error.includes('Database error')) {
                        errorMessage = 'Database error. Please try again.';
                    } else {
                        errorMessage = data.error;
                    }
                }
                alert('Error: ' + errorMessage);
            }
        } catch (error) {
            console.error('Network/parsing error:', error);
            alert('Failed to add note: ' + error.message);
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }
    
    // Set up event listeners with multiple attempts
    function setupListeners() {
        console.log('Setting up event listeners...');
        
        // Add Note Button
        const addNoteBtn = document.getElementById('addNoteBtn');
        console.log('Add Note button element:', addNoteBtn);
        if (addNoteBtn) {
            // Remove any existing listeners first
            addNoteBtn.onclick = null;
            addNoteBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Add Note button clicked!');
                console.log('About to call showModal()');
                showModal();
                console.log('showModal() called');
            };
            console.log('Add Note button listener added successfully');
            
            // Also try addEventListener as backup
            addNoteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Add Note button clicked via addEventListener!');
                showModal();
            });
            console.log('Add Note button addEventListener also added');
        } else {
            console.error('Add Note button not found!');
        }
        
        // Close buttons
        const closeBtn = document.getElementById('closeNoteModal');
        if (closeBtn) {
            closeBtn.onclick = hideModal;
            console.log('Close button listener added');
        }
        
        const cancelBtn = document.getElementById('cancelNoteBtn');
        if (cancelBtn) {
            cancelBtn.onclick = hideModal;
            console.log('Cancel button listener added');
        }
        
        // Form submission
        const form = document.getElementById('addNoteForm');
        if (form) {
            form.onsubmit = handleSubmit;
            console.log('Form listener added');
        }
        
        // Click outside to close
        const modal = document.getElementById('addNoteModal');
        if (modal) {
            modal.onclick = function(e) {
                if (e.target === modal) {
                    hideModal();
                }
            };
            console.log('Modal click listener added');
        }
    }
    
    // Try to set up listeners immediately
    setupListeners();
    setupRealTimeAnalysis();
    
    // Try again after a delay in case elements weren't ready
    setTimeout(setupListeners, 500);
    setTimeout(setupListeners, 1000);
    setTimeout(setupListeners, 2000);
    setTimeout(setupRealTimeAnalysis, 500);
    
    console.log('Add note modal setup complete!');
    
    // Test if modal exists
    const testModal = document.getElementById('addNoteModal');
    console.log('Modal exists test:', testModal);
    if (testModal) {
        console.log('Modal HTML:', testModal.outerHTML.substring(0, 200) + '...');
    }
    
    // Test backend connection
    console.log('Testing backend connection...');
    fetch(`/clients/${clientId}/notes`)
        .then(response => {
            console.log('Backend test - Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Backend test - Data received:', data);
        })
        .catch(error => {
            console.error('Backend test - Error:', error);
        });
    
    // Load notes when notes tab is clicked
    function loadNotes() {
        console.log('Loading notes for client:', clientId);
        
        const notesList = document.getElementById('notesList');
        const noNotesMessage = document.getElementById('noNotesMessage');
        const loadingMessage = document.getElementById('notesLoading');
        
        if (loadingMessage) loadingMessage.style.display = 'block';
        if (notesList) notesList.innerHTML = '';
        if (noNotesMessage) noNotesMessage.style.display = 'none';
        
        if (!clientId) {
            console.error('No client ID available');
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (noNotesMessage) noNotesMessage.style.display = 'block';
            return;
        }
        
        fetch(`/clients/${clientId}/notes`)
            .then(response => {
                console.log('Notes response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Notes response data:', data);
                console.log('Number of notes:', data.notes ? data.notes.length : 0);
                if (data.notes && data.notes.length > 0) {
                    displayNotes(data.notes);
                } else {
                    console.log('No notes found, showing no notes message');
                    if (noNotesMessage) noNotesMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading notes:', error);
                console.error('Error details:', error.message);
                if (noNotesMessage) {
                    noNotesMessage.innerHTML = `
                        <p>
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading notes: ${error.message}
                        </p>
                    `;
                    noNotesMessage.style.display = 'block';
                }
            })
            .finally(() => {
                if (loadingMessage) loadingMessage.style.display = 'none';
            });
    }
    
    // Function to display notes
    function displayNotes(notes) {
        const notesList = document.getElementById('notesList');
        const noNotesMessage = document.getElementById('noNotesMessage');
        
        if (!notesList) return;
        
        if (notes.length === 0) {
            if (noNotesMessage) noNotesMessage.style.display = 'block';
            return;
        }
        
        if (noNotesMessage) noNotesMessage.style.display = 'none';
        
        notesList.innerHTML = notes.map(note => {
            const date = new Date(note.created_at).toLocaleString();
            const sentiment = note.sentiment || {};
            const keywords = note.keywords || [];
            const tags = note.tags || {};
            
            // Get author information
            let authorDisplay = 'Staff Member';
            let authorRole = '';
            if (note.author) {
                if (typeof note.author === 'string') {
                    authorDisplay = note.author;
                } else if (note.author.email) {
                    authorDisplay = note.author.email;
                    if (note.author.role) {
                        authorRole = note.author.role;
                    }
                }
            }
            
            return `
                <div class="note-item" data-note-id="${note.note_id}">
                    <div class="note-header">
                        <div class="note-meta">
                            <span class="note-date">${date}</span>
                            <span class="note-author">
                                <i class="fas fa-user"></i>
                                ${authorDisplay}
                                ${authorRole ? `<span class="author-role">(${authorRole})</span>` : ''}
                            </span>
                        </div>
                        <div class="note-sentiment">
                            <span class="sentiment-badge sentiment-${sentiment.sentiment || 'neutral'}">
                                <i class="fas fa-${getSentimentIcon(sentiment.sentiment)}"></i>
                                ${sentiment.sentiment || 'neutral'}
                                ${sentiment.score ? ` (${sentiment.score.toFixed(2)})` : ''}
                            </span>
                        </div>
                    </div>
                    <p class="note-content">${note.text}</p>
                    
                    <div class="nlp-analysis">
                        ${keywords.length > 0 ? `
                            <div class="analysis-section">
                                <h4><i class="fas fa-tags"></i> Keywords</h4>
                                <div class="keywords">
                                    ${keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="analysis-section">
                            <h4><i class="fas fa-chart-line"></i> Domain Analysis</h4>
                            <div class="domain-analysis">
                                ${getDomainAnalysisHTML(tags)}
                            </div>
                        </div>
                        
                        ${sentiment.confidence ? `
                            <div class="analysis-section">
                                <h4><i class="fas fa-brain"></i> Analysis Confidence</h4>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${sentiment.confidence * 100}%"></div>
                                </div>
                                <span class="confidence-text">${(sentiment.confidence * 100).toFixed(1)}% confidence</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Helper function for sentiment icons
    function getSentimentIcon(sentiment) {
        switch (sentiment) {
            case 'positive': return 'smile';
            case 'negative': return 'frown';
            default: return 'meh';
        }
    }
    
    // Helper function for domain analysis HTML
    function getDomainAnalysisHTML(tags) {
        const domainLabels = {
            'emotional': 'Emotional State',
            'cognitive': 'Cognitive Function',
            'social': 'Social Interaction'
        };
        
        const domainIcons = {
            'emotional': 'fas fa-heart',
            'cognitive': 'fas fa-brain',
            'social': 'fas fa-users'
        };
        
        // Always show all three domains, even if they have zero scores
        const domains = ['emotional', 'cognitive', 'social'];
        
        return domains.map(domain => {
            const data = tags[domain] || { score: 0, counts: { positive: 0, negative: 0, neutral: 0 }, total_mentions: 0 };
            const score = data.score || 0;
            const totalMentions = data.total_mentions || 0;
            
            // Calculate bar width: score ranges from -1 to 1, so we map it to 0-100%
            // For display: -1 to 0 = 0% to 50%, 0 to 1 = 50% to 100%
            const barWidth = Math.max(0, Math.min(100, ((score + 1) / 2) * 100));
            
            // Determine color based on score
            let barColor = '#e0e0e0'; // neutral gray
            if (score > 0.1) barColor = '#4CAF50'; // positive green
            else if (score < -0.1) barColor = '#f44336'; // negative red
            else if (totalMentions > 0) barColor = '#ff9800'; // neutral orange
            
            return `
                <div class="domain-item">
                    <div class="domain-header">
                        <i class="${domainIcons[domain]}"></i>
                        <span class="domain-name">${domainLabels[domain]}</span>
                        <span class="domain-mentions">${totalMentions} mentions</span>
                    </div>
                    <div class="domain-score">
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${barWidth}%; background-color: ${barColor}"></div>
                        </div>
                        <span class="score-value">${score.toFixed(2)}</span>
                    </div>
                    <div class="domain-breakdown">
                        <span class="breakdown-item positive">+${data.counts.positive || 0}</span>
                        <span class="breakdown-item neutral">~${data.counts.neutral || 0}</span>
                        <span class="breakdown-item negative">-${data.counts.negative || 0}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Helper function for domain analysis preview HTML (smaller version for modal)
    function getDomainAnalysisPreviewHTML(tags) {
        const domainLabels = {
            'emotional': 'Emotional',
            'cognitive': 'Cognitive', 
            'social': 'Social'
        };
        
        const domainIcons = {
            'emotional': 'fas fa-heart',
            'cognitive': 'fas fa-brain',
            'social': 'fas fa-users'
        };
        
        // Always show all three domains, even if they have zero scores
        const domains = ['emotional', 'cognitive', 'social'];
        
        return domains.map(domain => {
            const data = tags[domain] || { score: 0, counts: { positive: 0, negative: 0, neutral: 0 }, total_mentions: 0 };
            const score = data.score || 0;
            const totalMentions = data.total_mentions || 0;
            
            // Calculate bar width: score ranges from -1 to 1, so we map it to 0-100%
            const barWidth = Math.max(0, Math.min(100, ((score + 1) / 2) * 100));
            
            // Determine color based on score
            let barColor = '#e0e0e0'; // neutral gray
            if (score > 0.1) barColor = '#4CAF50'; // positive green
            else if (score < -0.1) barColor = '#f44336'; // negative red
            else if (totalMentions > 0) barColor = '#ff9800'; // neutral orange
            
            return `
                <div class="domain-preview-item">
                    <div class="domain-preview-header">
                        <i class="${domainIcons[domain]}"></i>
                        <span class="domain-preview-name">${domainLabels[domain]}</span>
                        <span class="domain-preview-mentions">${totalMentions}</span>
                    </div>
                    <div class="domain-score-preview">
                        <div class="score-bar-preview">
                            <div class="score-fill-preview" style="width: ${barWidth}%; background-color: ${barColor}"></div>
                        </div>
                        <span class="score-value-preview">${score.toFixed(2)}</span>
                    </div>
                    <div class="domain-preview-breakdown">
                        <span class="breakdown-item-preview positive">+${data.counts.positive || 0}</span>
                        <span class="breakdown-item-preview neutral">~${data.counts.neutral || 0}</span>
                        <span class="breakdown-item-preview negative">-${data.counts.negative || 0}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Notes tab click listener is set up below with NLP summary
    
    // Real-time NLP Analysis for Add Note Modal
    let analysisTimeout;
    
    function setupRealTimeAnalysis() {
        const noteText = document.getElementById('noteText');
        const charCount = document.getElementById('charCount');
        const nlpPreview = document.getElementById('nlpPreview');
        
        if (noteText && charCount && nlpPreview) {
            // Character count
            noteText.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                
                // Show preview if text is long enough
                if (count > 10) {
                    nlpPreview.style.display = 'block';
                    analyzeTextRealTime(this.value);
                } else {
                    nlpPreview.style.display = 'none';
                }
            });
        }
    }
    
    function analyzeTextRealTime(text) {
        // Clear previous timeout
        if (analysisTimeout) {
            clearTimeout(analysisTimeout);
        }
        
        // Debounce the analysis
        analysisTimeout = setTimeout(async () => {
            try {
                console.log('Analyzing text in real-time:', text);
                
                // Show loading state
                updatePreviewLoading();
                
                // Call backend for analysis
                const response = await fetch('/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                if (response.ok) {
                    const analysis = await response.json();
                    updatePreviewWithAnalysis(analysis);
                } else {
                    updatePreviewError('Analysis failed');
                }
            } catch (error) {
                console.error('Real-time analysis error:', error);
                updatePreviewError('Analysis error');
            }
        }, 1000); // Wait 1 second after user stops typing
    }
    
    function updatePreviewLoading() {
        document.getElementById('sentimentPreview').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        document.getElementById('keywordsPreview').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting keywords...';
        document.getElementById('domainsPreview').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing domains...';
    }
    
    function updatePreviewWithAnalysis(analysis) {
        // Update sentiment
        const sentiment = analysis.sentiment || {};
        const sentimentPreview = document.getElementById('sentimentPreview');
        sentimentPreview.innerHTML = `
            <span class="sentiment-badge sentiment-${sentiment.sentiment || 'neutral'}">
                <i class="fas fa-${getSentimentIcon(sentiment.sentiment)}"></i>
                ${sentiment.sentiment || 'neutral'}
                ${sentiment.score ? ` (${sentiment.score.toFixed(2)})` : ''}
            </span>
        `;
        
        // Update keywords
        const keywords = analysis.keywords || [];
        const keywordsPreview = document.getElementById('keywordsPreview');
        if (keywords.length > 0) {
            keywordsPreview.innerHTML = keywords.map(keyword => 
                `<span class="keyword-tag">${keyword}</span>`
            ).join('');
        } else {
            keywordsPreview.innerHTML = '<span class="no-data">No keywords detected</span>';
        }
        
        // Update domains
        const tags = analysis.tags || {};
        const domainsPreview = document.getElementById('domainsPreview');
        domainsPreview.innerHTML = getDomainAnalysisPreviewHTML(tags);
    }
    
    function updatePreviewError(message) {
        document.getElementById('sentimentPreview').innerHTML = `<span class="error">${message}</span>`;
        document.getElementById('keywordsPreview').innerHTML = `<span class="error">${message}</span>`;
        document.getElementById('domainsPreview').innerHTML = `<span class="error">${message}</span>`;
    }
    
    // Load NLP Analysis Summary
    function loadNLPSummary() {
        console.log('Loading NLP summary for client:', clientId);
        
        const nlpSummary = document.getElementById('nlpSummary');
        if (!nlpSummary) {
            console.error('NLP summary element not found');
            return;
        }
        
        if (!clientId) {
            console.error('No client ID available for NLP summary');
            nlpSummary.innerHTML = '<p>Client ID not found</p>';
            return;
        }
        
        // Show loading state
        nlpSummary.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading analysis...</p>';
        
        fetch(`/clients/${clientId}/progress?period=weekly`)
            .then(response => {
                console.log('NLP summary response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('NLP summary response data:', data);
                if (data.progress && data.progress.weekly) {
                    displayNLPSummary(data.progress.weekly);
                } else {
                    nlpSummary.innerHTML = '<p>No analysis data available yet. Add some notes to see insights.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading NLP summary:', error);
                nlpSummary.innerHTML = `<p>Error loading analysis data: ${error.message}</p>`;
            });
    }
    
    // Function to display NLP summary
    function displayNLPSummary(progressData) {
        const nlpSummary = document.getElementById('nlpSummary');
        if (!nlpSummary) return;
        
        const sentiment = progressData.sentiment || {};
        const domains = progressData.domains || {};
        const keywords = progressData.keyword_frequency || {};
        
        nlpSummary.innerHTML = `
            <div class="summary-section">
                <h4><i class="fas fa-heart"></i> Sentiment Overview</h4>
                <div class="sentiment-overview">
                    <div class="sentiment-item">
                        <span class="sentiment-label positive">Positive</span>
                        <span class="sentiment-count">${sentiment.counts?.positive || 0}</span>
                        <span class="sentiment-percentage">(${sentiment.distribution?.positive_pct || 0}%)</span>
                    </div>
                    <div class="sentiment-item">
                        <span class="sentiment-label neutral">Neutral</span>
                        <span class="sentiment-count">${sentiment.counts?.neutral || 0}</span>
                        <span class="sentiment-percentage">(${sentiment.distribution?.neutral_pct || 0}%)</span>
                    </div>
                    <div class="sentiment-item">
                        <span class="sentiment-label negative">Negative</span>
                        <span class="sentiment-count">${sentiment.counts?.negative || 0}</span>
                        <span class="sentiment-percentage">(${sentiment.distribution?.negative_pct || 0}%)</span>
                    </div>
                </div>
                <div class="average-sentiment">
                    <strong>Average Score: ${sentiment.average_score || 0}</strong>
                </div>
            </div>

            <div class="summary-section">
                <h4><i class="fas fa-chart-line"></i> Domain Trends</h4>
                <div class="domain-trends">
                    ${Object.entries(domains).map(([domain, data]) => `
                        <div class="domain-trend">
                            <span class="domain-name">${domain}</span>
                            <div class="trend-bar">
                                <div class="trend-fill" style="width: ${Math.abs(data.score) * 100}%; background-color: ${data.score >= 0 ? '#4CAF50' : '#f44336'}"></div>
                            </div>
                            <span class="trend-score">${data.score.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="summary-section">
                <h4><i class="fas fa-search"></i> Top Keywords</h4>
                <div class="top-keywords">
                    ${Object.entries(keywords).slice(0, 5).map(([keyword, count]) => `
                        <span class="keyword-item">
                            <span class="keyword-text">${keyword}</span>
                            <span class="keyword-count">${count}</span>
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Set up NLP summary loading when notes tab is clicked
    const notesTab = document.querySelector('[data-tab="notes"]');
    if (notesTab) {
        // Update the existing click listener to also load NLP summary
        const originalClickHandler = notesTab.onclick;
        notesTab.addEventListener('click', function() {
            console.log('Notes tab clicked, loading notes and NLP summary...');
            setTimeout(() => {
                loadNotes();
                loadNLPSummary();
            }, 100);
        });
    }
    
    // Also try to load notes and NLP summary immediately if we're already on the notes tab
    setTimeout(() => {
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab && activeTab.id === 'notes') {
            console.log('Already on notes tab, loading notes and NLP summary...');
            loadNotes();
            loadNLPSummary();
        }
    }, 1000);
    
    // Set up progress tab click handler
    const progressTab = document.querySelector('[data-tab="progress"]');
    if (progressTab) {
        progressTab.addEventListener('click', function() {
            console.log('Progress tab clicked, loading progress data...');
            setTimeout(() => {
                if (typeof loadProgressData === 'function') {
                    loadProgressData();
                }
            }, 100);
        });
    }
    
    // Also try to load progress data immediately if we're already on the progress tab
    setTimeout(() => {
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab && activeTab.id === 'progress') {
            console.log('Already on progress tab, loading progress data...');
            if (typeof loadProgressData === 'function') {
                loadProgressData();
            }
        }
    }, 1000);
});
</script>
{% endblock %}