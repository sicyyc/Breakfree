{% extends "base.html" %}
{% block title %}Add New Client - Step 3: Pre-Assessment - BreakFree{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_client.css') }}" />
<style>
  .wizard-progress {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
  }
  
  .progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .progress-steps::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
  }
  
  .step {
    position: relative;
    z-index: 2;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #6c757d;
  }
  
  .step.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }
  
  .step.completed {
    border-color: #28a745;
    background: #28a745;
    color: white;
  }
  
  .step-label {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: #6c757d;
    white-space: nowrap;
    text-align: center;
  }
  
  .step.active .step-label {
    color: #007bff;
    font-weight: bold;
  }
  
  .step.completed .step-label {
    color: #28a745;
    font-weight: bold;
  }

  .assessment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .assessment-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .assessment-card h4 {
    margin-bottom: 15px;
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
  }

  .scale-question {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background: #f8f9fa;
  }

  .scale-question label {
    display: block;
    margin-bottom: 10px;
    font-weight: 500;
    color: #495057;
  }

  .scale-options {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .scale-option {
    flex: 1;
    text-align: center;
    padding: 8px;
    border: 2px solid #e9ecef;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
  }

  .scale-option:hover {
    border-color: #007bff;
    background: #f8f9fa;
  }

  .scale-option.selected {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }

  .scale-option input[type="radio"] {
    display: none;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .checkbox-item:hover {
    background: #f8f9fa;
  }

  .checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  .text-area-group {
    margin-bottom: 15px;
  }

  .text-area-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
  }

  .text-area-group textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
  }

  .text-area-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
  }
</style>
{% endblock %}

{% block content %}
<div class="main-header">
  <div>
    <h1>Add New Client</h1>
    <p>Step 3 of 3: Pre-Assessment</p>
  </div>
  <div class="actions">
    <a href="{{ url_for('clients') }}" class="btn-secondary">
      <i class="fas fa-arrow-left"></i>
      Back to Clients
    </a>
  </div>
</div>

<!-- Wizard Progress Bar -->
<div class="wizard-progress">
  <div class="progress-steps">
    <div class="step completed">
      <span>1</span>
      <div class="step-label">Personal Info</div>
    </div>
    <div class="step completed">
      <span>2</span>
      <div class="step-label">Progress Monitoring</div>
    </div>
    <div class="step active">
      <span>3</span>
      <div class="step-label">Pre-Assessment</div>
    </div>
  </div>
</div>

<div class="add-client-container">
  <form id="preAssessmentForm" class="add-client-form">
    <!-- Substance Use Assessment -->
    <div class="form-section">
      <h3><i class="fas fa-flask"></i> Substance Use Assessment</h3>
      
      <div class="assessment-grid">
        <!-- Primary Substance -->
        <div class="assessment-card">
          <h4><i class="fas fa-exclamation-circle"></i> Primary Substance</h4>
          <div class="form-group">
            <label for="primarySubstance">What is the primary substance of concern?</label>
            <select id="primarySubstance" name="primarySubstance" required class="input-enhanced">
              <option value="">Select primary substance</option>
              <option value="alcohol">Alcohol</option>
              <option value="marijuana">Marijuana</option>
              <option value="cocaine">Cocaine</option>
              <option value="methamphetamine">Methamphetamine</option>
              <option value="heroin">Heroin</option>
              <option value="prescription_opioids">Prescription Opioids</option>
              <option value="benzodiazepines">Benzodiazepines</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="text-area-group">
            <label for="otherSubstance">If other, please specify:</label>
            <textarea id="otherSubstance" name="otherSubstance" placeholder="Describe the substance..."></textarea>
          </div>
        </div>

        <!-- Usage Pattern -->
        <div class="assessment-card">
          <h4><i class="fas fa-clock"></i> Usage Pattern</h4>
          <div class="form-group">
            <label for="usageFrequency">How often do you use the primary substance?</label>
            <select id="usageFrequency" name="usageFrequency" required class="input-enhanced">
              <option value="">Select frequency</option>
              <option value="daily">Daily</option>
              <option value="several_times_week">Several times a week</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="occasionally">Occasionally</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="usageDuration">How long have you been using this substance?</label>
            <select id="usageDuration" name="usageDuration" required class="input-enhanced">
              <option value="">Select duration</option>
              <option value="less_than_6_months">Less than 6 months</option>
              <option value="6_months_to_1_year">6 months to 1 year</option>
              <option value="1_to_3_years">1 to 3 years</option>
              <option value="3_to_5_years">3 to 5 years</option>
              <option value="more_than_5_years">More than 5 years</option>
            </select>
          </div>
        </div>

        <!-- Severity Assessment -->
        <div class="assessment-card">
          <h4><i class="fas fa-chart-bar"></i> Severity Assessment</h4>
          
          <div class="scale-question">
            <label>Rate your current level of substance use (1 = Very Low, 5 = Very High):</label>
            <div class="scale-options">
              <div class="scale-option" data-value="1">
                <input type="radio" name="useSeverity" value="1" id="severity1">
                <label for="severity1">1<br><small>Very Low</small></label>
              </div>
              <div class="scale-option" data-value="2">
                <input type="radio" name="useSeverity" value="2" id="severity2">
                <label for="severity2">2<br><small>Low</small></label>
              </div>
              <div class="scale-option" data-value="3">
                <input type="radio" name="useSeverity" value="3" id="severity3">
                <label for="severity3">3<br><small>Moderate</small></label>
              </div>
              <div class="scale-option" data-value="4">
                <input type="radio" name="useSeverity" value="4" id="severity4">
                <label for="severity4">4<br><small>High</small></label>
              </div>
              <div class="scale-option" data-value="5">
                <input type="radio" name="useSeverity" value="5" id="severity5">
                <label for="severity5">5<br><small>Very High</small></label>
              </div>
            </div>
          </div>

          <div class="scale-question">
            <label>How much does substance use interfere with daily life? (1 = Not at all, 5 = Extremely):</label>
            <div class="scale-options">
              <div class="scale-option" data-value="1">
                <input type="radio" name="lifeInterference" value="1" id="interference1">
                <label for="interference1">1<br><small>Not at all</small></label>
              </div>
              <div class="scale-option" data-value="2">
                <input type="radio" name="lifeInterference" value="2" id="interference2">
                <label for="interference2">2<br><small>Slightly</small></label>
              </div>
              <div class="scale-option" data-value="3">
                <input type="radio" name="lifeInterference" value="3" id="interference3">
                <label for="interference3">3<br><small>Moderately</small></label>
              </div>
              <div class="scale-option" data-value="4">
                <input type="radio" name="lifeInterference" value="4" id="interference4">
                <label for="interference4">4<br><small>Significantly</small></label>
              </div>
              <div class="scale-option" data-value="5">
                <input type="radio" name="lifeInterference" value="5" id="interference5">
                <label for="interference5">5<br><small>Extremely</small></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mental Health Assessment -->
    <div class="form-section">
      <h3><i class="fas fa-brain"></i> Mental Health Assessment</h3>
      
      <div class="assessment-grid">
        <!-- Mental Health History -->
        <div class="assessment-card">
          <h4><i class="fas fa-history"></i> Mental Health History</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="depression" name="mentalHealthConditions" value="depression">
              <label for="depression">Depression</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="anxiety" name="mentalHealthConditions" value="anxiety">
              <label for="anxiety">Anxiety</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="bipolar" name="mentalHealthConditions" value="bipolar">
              <label for="bipolar">Bipolar Disorder</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="ptsd" name="mentalHealthConditions" value="ptsd">
              <label for="ptsd">PTSD</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="adhd" name="mentalHealthConditions" value="adhd">
              <label for="adhd">ADHD</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="schizophrenia" name="mentalHealthConditions" value="schizophrenia">
              <label for="schizophrenia">Schizophrenia</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="other_mental" name="mentalHealthConditions" value="other">
              <label for="other_mental">Other</label>
            </div>
          </div>
          
          <div class="text-area-group">
            <label for="mentalHealthNotes">Additional mental health notes:</label>
            <textarea id="mentalHealthNotes" name="mentalHealthNotes" placeholder="Describe any mental health concerns..."></textarea>
          </div>
        </div>

        <!-- Current Mental State -->
        <div class="assessment-card">
          <h4><i class="fas fa-heart"></i> Current Mental State</h4>
          
          <div class="scale-question">
            <label>Rate your current mood (1 = Very Poor, 5 = Excellent):</label>
            <div class="scale-options">
              <div class="scale-option" data-value="1">
                <input type="radio" name="currentMood" value="1" id="mood1">
                <label for="mood1">1<br><small>Very Poor</small></label>
              </div>
              <div class="scale-option" data-value="2">
                <input type="radio" name="currentMood" value="2" id="mood2">
                <label for="mood2">2<br><small>Poor</small></label>
              </div>
              <div class="scale-option" data-value="3">
                <input type="radio" name="currentMood" value="3" id="mood3">
                <label for="mood3">3<br><small>Fair</small></label>
              </div>
              <div class="scale-option" data-value="4">
                <input type="radio" name="currentMood" value="4" id="mood4">
                <label for="mood4">4<br><small>Good</small></label>
              </div>
              <div class="scale-option" data-value="5">
                <input type="radio" name="currentMood" value="5" id="mood5">
                <label for="mood5">5<br><small>Excellent</small></label>
              </div>
            </div>
          </div>

          <div class="scale-question">
            <label>How would you rate your stress level? (1 = Very Low, 5 = Very High):</label>
            <div class="scale-options">
              <div class="scale-option" data-value="1">
                <input type="radio" name="stressLevel" value="1" id="stress1">
                <label for="stress1">1<br><small>Very Low</small></label>
              </div>
              <div class="scale-option" data-value="2">
                <input type="radio" name="stressLevel" value="2" id="stress2">
                <label for="stress2">2<br><small>Low</small></label>
              </div>
              <div class="scale-option" data-value="3">
                <input type="radio" name="stressLevel" value="3" id="stress3">
                <label for="stress3">3<br><small>Moderate</small></label>
              </div>
              <div class="scale-option" data-value="4">
                <input type="radio" name="stressLevel" value="4" id="stress4">
                <label for="stress4">4<br><small>High</small></label>
              </div>
              <div class="scale-option" data-value="5">
                <input type="radio" name="stressLevel" value="5" id="stress5">
                <label for="stress5">5<br><small>Very High</small></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Social Support Assessment -->
    <div class="form-section">
      <h3><i class="fas fa-users"></i> Social Support Assessment</h3>
      
      <div class="assessment-grid">
        <!-- Support Network -->
        <div class="assessment-card">
          <h4><i class="fas fa-network-wired"></i> Support Network</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="family_support" name="supportNetwork" value="family">
              <label for="family_support">Family Support</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="friends_support" name="supportNetwork" value="friends">
              <label for="friends_support">Friends Support</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="spiritual_support" name="supportNetwork" value="spiritual">
              <label for="spiritual_support">Spiritual/Religious Support</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="professional_support" name="supportNetwork" value="professional">
              <label for="professional_support">Professional Support</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="support_groups" name="supportNetwork" value="support_groups">
              <label for="support_groups">Support Groups</label>
            </div>
          </div>
        </div>

        <!-- Living Situation -->
        <div class="assessment-card">
          <h4><i class="fas fa-home"></i> Living Situation</h4>
          <div class="form-group">
            <label for="livingSituation">Current living situation:</label>
            <select id="livingSituation" name="livingSituation" required class="input-enhanced">
              <option value="">Select living situation</option>
              <option value="alone">Living Alone</option>
              <option value="with_family">Living with Family</option>
              <option value="with_friends">Living with Friends</option>
              <option value="shelter">Shelter/Homeless</option>
              <option value="recovery_home">Recovery Home</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="text-area-group">
            <label for="livingSituationNotes">Additional notes about living situation:</label>
            <textarea id="livingSituationNotes" name="livingSituationNotes" placeholder="Describe your living situation..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" id="prevStep" class="btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Previous Step
      </button>
      <button type="submit" id="submitForm" class="btn-primary">
        <i class="fas fa-check"></i>
        Complete Registration
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load previous form data
    const previousData = sessionStorage.getItem('clientFormData');
    if (previousData) {
        const data = JSON.parse(previousData);
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'radio' || element.type === 'checkbox') {
                    if (Array.isArray(data[key])) {
                        data[key].forEach(value => {
                            const checkbox = document.querySelector(`input[name="${key}"][value="${value}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    } else {
                        const radio = document.querySelector(`input[name="${key}"][value="${data[key]}"]`);
                        if (radio) radio.checked = true;
                    }
                } else {
                    element.value = data[key];
                }
            }
        });
    }

    // Scale option functionality
    const scaleOptions = document.querySelectorAll('.scale-option');
    scaleOptions.forEach(option => {
        option.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                // Remove selected class from siblings
                const siblings = this.parentElement.querySelectorAll('.scale-option');
                siblings.forEach(sib => sib.classList.remove('selected'));
                // Add selected class to clicked option
                this.classList.add('selected');
                // Check the radio button
                radio.checked = true;
            }
        });
    });

    // Navigation buttons
    const prevStepBtn = document.getElementById('prevStep');
    const submitFormBtn = document.getElementById('submitForm');
    let isSubmitting = false;

    prevStepBtn.addEventListener('click', function() {
        saveFormData();
        window.location.href = "{{ url_for('add_client_step2') }}";
    });

    submitFormBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (isSubmitting) return;
        if (validateForm()) {
            isSubmitting = true;
            submitFormBtn.disabled = true;
            const originalText = submitFormBtn.innerHTML;
            submitFormBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            saveFormData();
            submitClientData().finally(() => {
                isSubmitting = false;
                submitFormBtn.disabled = false;
                submitFormBtn.innerHTML = originalText;
            });
        }
    });

    function saveFormData() {
        const form = document.getElementById('preAssessmentForm');
        const formData = new FormData(form);
        const formDataObj = {};
        const previousData = JSON.parse(sessionStorage.getItem('clientFormData') || '{}');
        
        formData.forEach((value, key) => {
            formDataObj[key] = value;
        });

        // Handle checkboxes
        const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            if (!formDataObj[checkbox.name]) {
                formDataObj[checkbox.name] = [];
            }
            if (Array.isArray(formDataObj[checkbox.name])) {
                formDataObj[checkbox.name].push(checkbox.value);
            }
        });

        // Handle radio buttons
        const radios = form.querySelectorAll('input[type="radio"]:checked');
        radios.forEach(radio => {
            formDataObj[radio.name] = radio.value;
        });

        const mergedData = { ...previousData, ...formDataObj };
        sessionStorage.setItem('clientFormData', JSON.stringify(mergedData));
    }

    function validateForm() {
        const form = document.getElementById('preAssessmentForm');
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('error');
                isValid = false;
            } else {
                field.classList.remove('error');
            }
        });

        // Check if at least one scale question is answered
        const scaleQuestions = ['useSeverity', 'lifeInterference', 'currentMood', 'stressLevel'];
        scaleQuestions.forEach(questionName => {
            const answered = form.querySelector(`input[name="${questionName}"]:checked`);
            if (!answered) {
                alert(`Please answer the ${questionName.replace(/([A-Z])/g, ' $1').toLowerCase()} question.`);
                isValid = false;
            }
        });

        return isValid;
    }
    function submitClientData() {
        const formData = JSON.parse(sessionStorage.getItem('clientFormData') || '{}');

        const submitData = new FormData();

        Object.keys(formData).forEach(key => {
            if (Array.isArray(formData[key])) {
                formData[key].forEach(value => submitData.append(key, value));
            } else {
                submitData.append(key, formData[key]);
            }
        });

        const imageFile = sessionStorage.getItem('clientImageFile');
        if (imageFile) {
            const byteCharacters = atob(imageFile.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            const file = new File([blob], 'client_image.jpg', { type: 'image/jpeg' });
            submitData.append('image', file);
        }

        return fetch("{{ url_for('add_client') }}", { method: 'POST', body: submitData })
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(data => {
            if (data.success) {
              alert('Client registered successfully!');
              sessionStorage.removeItem('clientFormData');
              sessionStorage.removeItem('clientImageFile');
              window.location.href = "{{ url_for('clients') }}";
            } else {
              alert('Error: ' + (data.error || 'Failed to register client'));
            }
          })
          .catch(err => {
            console.error(err);
            alert('An error occurred while registering the client. Please try again.');
          });
    }
});
</script>
{% endblock %}
