{% extends "base.html" %}
{% block title %}Add New Client - Step 4: Intervention Plan - BreakFree{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_client.css') }}" />
<style>
  .wizard-progress {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
  }
  
  .progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .progress-steps::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
  }
  
  .step {
    position: relative;
    z-index: 2;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #6c757d;
  }
  
  .step.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }
  
  .step.completed {
    border-color: #28a745;
    background: #28a745;
    color: white;
  }
  
  .step-label {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: #6c757d;
    white-space: nowrap;
    text-align: center;
  }
  
  .step.active .step-label {
    color: #007bff;
    font-weight: bold;
  }
  
  .step.completed .step-label {
    color: #28a745;
    font-weight: bold;
  }

  .intervention-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .intervention-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .intervention-card h4 {
    margin-bottom: 15px;
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .checkbox-item:hover {
    background: #f8f9fa;
  }

  .checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  .text-area-group {
    margin-bottom: 15px;
  }

  .text-area-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
  }

  .text-area-group textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
  }

  .text-area-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
  }

  .priority-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .priority-option {
    flex: 1;
    text-align: center;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .priority-option:hover {
    border-color: #007bff;
  }

  .priority-option.selected {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }

  .summary-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .summary-section h3 {
    color: #495057;
    margin-bottom: 15px;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  .summary-item {
    background: white;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
  }

  .summary-item h5 {
    margin: 0 0 8px 0;
    color: #495057;
    font-size: 14px;
  }

  .summary-item p {
    margin: 0;
    color: #6c757d;
    font-size: 13px;
  }
</style>
{% endblock %}

{% block content %}
<div class="main-header">
  <div>
    <h1>Add New Client</h1>
    <p>Step 4 of 4: Intervention Plan</p>
  </div>
  <div class="actions">
    <a href="{{ url_for('clients') }}" class="btn-secondary">
      <i class="fas fa-arrow-left"></i>
      Back to Clients
    </a>
  </div>
</div>

<!-- Wizard Progress Bar -->
<div class="wizard-progress">
  <div class="progress-steps">
    <div class="step completed">
      <span>1</span>
      <div class="step-label">Personal Info</div>
    </div>
    <div class="step completed">
      <span>2</span>
      <div class="step-label">Progress Monitoring</div>
    </div>
    <div class="step completed">
      <span>3</span>
      <div class="step-label">Pre-Assessment</div>
    </div>
    <div class="step active">
      <span>4</span>
      <div class="step-label">Intervention Plan</div>
    </div>
  </div>
</div>

<div class="add-client-container">
  <form id="interventionPlanForm" class="add-client-form">
    <!-- Treatment Goals -->
    <div class="form-section">
      <h3><i class="fas fa-bullseye"></i> Treatment Goals</h3>
      
      <div class="intervention-grid">
        <!-- Primary Goals -->
        <div class="intervention-card">
          <h4><i class="fas fa-flag"></i> Primary Goals</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="abstinence" name="primaryGoals" value="abstinence">
              <label for="abstinence">Achieve and maintain abstinence</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="reduce_use" name="primaryGoals" value="reduce_use">
              <label for="reduce_use">Reduce substance use</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="harm_reduction" name="primaryGoals" value="harm_reduction">
              <label for="harm_reduction">Harm reduction</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="relapse_prevention" name="primaryGoals" value="relapse_prevention">
              <label for="relapse_prevention">Relapse prevention</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="mental_health" name="primaryGoals" value="mental_health">
              <label for="mental_health">Improve mental health</label>
            </div>
          </div>
        </div>

        <!-- Secondary Goals -->
        <div class="intervention-card">
          <h4><i class="fas fa-star"></i> Secondary Goals</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="employment" name="secondaryGoals" value="employment">
              <label for="employment">Employment/Education</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="housing" name="secondaryGoals" value="housing">
              <label for="housing">Stable housing</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="relationships" name="secondaryGoals" value="relationships">
              <label for="relationships">Improve relationships</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="legal" name="secondaryGoals" value="legal">
              <label for="legal">Legal issues resolution</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="life_skills" name="secondaryGoals" value="life_skills">
              <label for="life_skills">Life skills development</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Treatment Modalities -->
    <div class="form-section">
      <h3><i class="fas fa-tools"></i> Treatment Modalities</h3>
      
      <div class="intervention-grid">
        <!-- Individual Therapy -->
        <div class="intervention-card">
          <h4><i class="fas fa-user"></i> Individual Therapy</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="cbt" name="individualTherapy" value="cbt">
              <label for="cbt">Cognitive Behavioral Therapy (CBT)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="motivational_interviewing" name="individualTherapy" value="motivational_interviewing">
              <label for="motivational_interviewing">Motivational Interviewing</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="trauma_therapy" name="individualTherapy" value="trauma_therapy">
              <label for="trauma_therapy">Trauma-Informed Therapy</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="dialectical_behavioral" name="individualTherapy" value="dialectical_behavioral">
              <label for="dialectical_behavioral">Dialectical Behavioral Therapy</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="other_individual" name="individualTherapy" value="other">
              <label for="other_individual">Other</label>
            </div>
          </div>
        </div>

        <!-- Group Therapy -->
        <div class="intervention-card">
          <h4><i class="fas fa-users"></i> Group Therapy</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="support_groups" name="groupTherapy" value="support_groups">
              <label for="support_groups">Support Groups</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="skills_groups" name="groupTherapy" value="skills_groups">
              <label for="skills_groups">Skills Groups</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="process_groups" name="groupTherapy" value="process_groups">
              <label for="process_groups">Process Groups</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="family_groups" name="groupTherapy" value="family_groups">
              <label for="family_groups">Family Groups</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="other_group" name="groupTherapy" value="other">
              <label for="other_group">Other</label>
            </div>
          </div>
        </div>

        <!-- Medication Management -->
        <div class="intervention-card">
          <h4><i class="fas fa-pills"></i> Medication Management</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="mat" name="medicationManagement" value="mat">
              <label for="mat">Medication-Assisted Treatment (MAT)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="psychiatric_meds" name="medicationManagement" value="psychiatric_meds">
              <label for="psychiatric_meds">Psychiatric Medications</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="withdrawal_management" name="medicationManagement" value="withdrawal_management">
              <label for="withdrawal_management">Withdrawal Management</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="no_medication" name="medicationManagement" value="no_medication">
              <label for="no_medication">No Medication Required</label>
            </div>
          </div>
        </div>

        <!-- Support Services -->
        <div class="intervention-card">
          <h4><i class="fas fa-hands-helping"></i> Support Services</h4>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="case_management" name="supportServices" value="case_management">
              <label for="case_management">Case Management</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="vocational" name="supportServices" value="vocational">
              <label for="vocational">Vocational Services</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="housing_assistance" name="supportServices" value="housing_assistance">
              <label for="housing_assistance">Housing Assistance</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="legal_assistance" name="supportServices" value="legal_assistance">
              <label for="legal_assistance">Legal Assistance</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="transportation" name="supportServices" value="transportation">
              <label for="transportation">Transportation Services</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Treatment Plan Details -->
    <div class="form-section">
      <h3><i class="fas fa-clipboard-list"></i> Treatment Plan Details</h3>
      
      <div class="intervention-grid">
        <!-- Treatment Priority -->
        <div class="intervention-card">
          <h4><i class="fas fa-exclamation-triangle"></i> Treatment Priority</h4>
          <div class="priority-selector">
            <div class="priority-option" data-value="low">
              <strong>Low</strong><br><small>Standard care</small>
            </div>
            <div class="priority-option" data-value="medium">
              <strong>Medium</strong><br><small>Enhanced care</small>
            </div>
            <div class="priority-option" data-value="high">
              <strong>High</strong><br><small>Intensive care</small>
            </div>
            <div class="priority-option" data-value="crisis">
              <strong>Crisis</strong><br><small>Immediate intervention</small>
            </div>
          </div>
          <input type="hidden" id="treatmentPriority" name="treatmentPriority" required />
        </div>

        <!-- Expected Duration -->
        <div class="intervention-card">
          <h4><i class="fas fa-calendar-alt"></i> Expected Duration</h4>
          <div class="form-group">
            <label for="treatmentDuration">Expected treatment duration:</label>
            <select id="treatmentDuration" name="treatmentDuration" required class="input-enhanced">
              <option value="">Select duration</option>
              <option value="30_days">30 days</option>
              <option value="60_days">60 days</option>
              <option value="90_days">90 days</option>
              <option value="6_months">6 months</option>
              <option value="1_year">1 year</option>
              <option value="ongoing">Ongoing</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Treatment Notes -->
      <div class="text-area-group">
        <label for="treatmentNotes">Treatment Plan Notes:</label>
        <textarea id="treatmentNotes" name="treatmentNotes" placeholder="Additional notes about the treatment plan, special considerations, or specific interventions..."></textarea>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-section">
      <h3><i class="fas fa-info-circle"></i> Client Summary</h3>
      <div class="summary-grid" id="clientSummary">
        <!-- Summary will be populated by JavaScript -->
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" id="prevStep" class="btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Previous Step
      </button>
      <button type="submit" id="submitForm" class="btn-primary">
        <i class="fas fa-check"></i>
        Complete Registration
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load previous form data
    const previousData = sessionStorage.getItem('clientFormData');
    if (previousData) {
        const data = JSON.parse(previousData);
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    if (Array.isArray(data[key])) {
                        data[key].forEach(value => {
                            const checkbox = document.querySelector(`input[name="${key}"][value="${value}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } else {
                    element.value = data[key];
                }
            }
        });
    }

    // Priority selector functionality
    const priorityOptions = document.querySelectorAll('.priority-option');
    const priorityInput = document.getElementById('treatmentPriority');

    priorityOptions.forEach(option => {
        option.addEventListener('click', function() {
            priorityOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            priorityInput.value = this.dataset.value;
        });
    });

    // Navigation buttons
    const prevStepBtn = document.getElementById('prevStep');
    const submitFormBtn = document.getElementById('submitForm');

    prevStepBtn.addEventListener('click', function() {
        saveFormData();
        window.location.href = "{{ url_for('add_client_step3') }}";
    });

    submitFormBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (validateForm()) {
            saveFormData();
            submitClientData();
        }
    });

    // Populate summary
    populateSummary();

    function saveFormData() {
        const form = document.getElementById('interventionPlanForm');
        const formData = new FormData(form);
        const formDataObj = {};
        const previousData = JSON.parse(sessionStorage.getItem('clientFormData') || '{}');
        
        formData.forEach((value, key) => {
            formDataObj[key] = value;
        });

        // Handle checkboxes
        const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            if (!formDataObj[checkbox.name]) {
                formDataObj[checkbox.name] = [];
            }
            if (Array.isArray(formDataObj[checkbox.name])) {
                formDataObj[checkbox.name].push(checkbox.value);
            }
        });

        const mergedData = { ...previousData, ...formDataObj };
        sessionStorage.setItem('clientFormData', JSON.stringify(mergedData));
    }

    function validateForm() {
        const form = document.getElementById('interventionPlanForm');
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('error');
                isValid = false;
            } else {
                field.classList.remove('error');
            }
        });

        // Check if at least one primary goal is selected
        const primaryGoals = form.querySelectorAll('input[name="primaryGoals"]:checked');
        if (primaryGoals.length === 0) {
            alert('Please select at least one primary goal.');
            isValid = false;
        }

        return isValid;
    }

    function populateSummary() {
        const summaryContainer = document.getElementById('clientSummary');
        const data = JSON.parse(sessionStorage.getItem('clientFormData') || '{}');
        
        const summaryItems = [
            {
                title: 'Personal Information',
                content: `${data.firstName || 'N/A'} ${data.surname || 'N/A'}, ${data.age || 'N/A'} years old, ${data.gender || 'N/A'}`
            },
            {
                title: 'Contact',
                content: `Phone: ${data.phone || 'N/A'}, Emergency: ${data.emergency_name || 'N/A'}`
            },
            {
                title: 'Address',
                content: data.address || 'N/A'
            },
            {
                title: 'Program Details',
                content: `Status: ${data.status || 'N/A'}, Care Type: ${data.care_type || 'N/A'}`
            },
            {
                title: 'Primary Substance',
                content: data.primarySubstance || 'N/A'
            },
            {
                title: 'Usage Pattern',
                content: `${data.usageFrequency || 'N/A'} for ${data.usageDuration || 'N/A'}`
            }
        ];

        summaryContainer.innerHTML = summaryItems.map(item => `
            <div class="summary-item">
                <h5>${item.title}</h5>
                <p>${item.content}</p>
            </div>
        `).join('');
    }

    function submitClientData() {
        const formData = JSON.parse(sessionStorage.getItem('clientFormData') || '{}');
        
        // Debug: Log the form data
        console.log('Submitting form data:', formData);
        
        // Create FormData object for submission
        const submitData = new FormData();
        
        // Add all form data
        Object.keys(formData).forEach(key => {
            if (Array.isArray(formData[key])) {
                formData[key].forEach(value => {
                    submitData.append(key, value);
                });
            } else {
                submitData.append(key, formData[key]);
            }
        });

        // Handle image file if it exists in sessionStorage
        const imageFile = sessionStorage.getItem('clientImageFile');
        if (imageFile) {
            // Convert base64 back to file
            const byteCharacters = atob(imageFile.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            const file = new File([blob], 'client_image.jpg', { type: 'image/jpeg' });
            submitData.append('image', file);
        }

        // Submit to the original add_client endpoint
        fetch("{{ url_for('add_client') }}", {
            method: 'POST',
            body: submitData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Client registered successfully!');
                sessionStorage.removeItem('clientFormData');
                sessionStorage.removeItem('clientImageFile');
                window.location.href = "{{ url_for('clients') }}";
            } else {
                alert('Error: ' + (data.error || 'Failed to register client'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while registering the client. Please try again.');
        });
    }
});
</script>
{% endblock %}
